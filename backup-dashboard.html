<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <meta name="description" content="Backup Dashboard - Automated backup and recovery for SPORTIQ">
    <meta name="keywords" content="SPORTIQ, Backup, Recovery, Data Protection">

    <title>Backup Dashboard - SPORTIQ</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/layer74-backup.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/icons/favicon.ico">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="nav-brand">SPORTIQ</a>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <a href="index.html" class="btn btn-outline btn-sm">‚Üê Back to Home</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container backup-dashboard">
        <!-- Page Header -->
        <div class="backup-header">
            <h1 class="backup-title">üíæ Backup & Recovery</h1>
            <p class="backup-subtitle">Automated Data Protection & Instant Recovery</p>
        </div>

        <!-- Stats -->
        <div class="backup-stats">
            <div class="backup-stat-card">
                <div class="backup-stat-icon">üíæ</div>
                <div class="backup-stat-value" id="statTotalBackups">0</div>
                <div class="backup-stat-label">Total Backups</div>
            </div>
            <div class="backup-stat-card">
                <div class="backup-stat-icon">‚úÖ</div>
                <div class="backup-stat-value" id="statSuccessRate">0%</div>
                <div class="backup-stat-label">Success Rate</div>
            </div>
            <div class="backup-stat-card">
                <div class="backup-stat-icon">üì¶</div>
                <div class="backup-stat-value" id="statStorageUsed">0 KB</div>
                <div class="backup-stat-label">Storage Used</div>
            </div>
            <div class="backup-stat-card">
                <div class="backup-stat-icon">üîÑ</div>
                <div class="backup-stat-value" id="statActiveSchedules">0</div>
                <div class="backup-stat-label">Active Schedules</div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Control Panel -->
        <div class="backup-control-panel">
            <div class="backup-control-header">
                <h2 class="backup-control-title">üéõÔ∏è Backup Control</h2>
                <div class="backup-control-actions">
                    <button class="btn btn-primary" onclick="createBackup()">üíæ Create Backup</button>
                    <button class="btn btn-secondary" onclick="refreshDashboard()">‚Üª Refresh</button>
                </div>
            </div>

            <div class="backup-source-selector">
                <h3 style="margin-bottom: 0.75rem;">Select Sources to Backup:</h3>
                <div class="backup-source-grid" id="sourceSelector">
                    <div class="backup-loading">
                        <div class="backup-spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="backup-schedule">
            <div class="backup-schedule-header">
                <h2 class="backup-schedule-title">‚è∞ Backup Schedules</h2>
            </div>
            <div class="backup-schedule-list" id="scheduleList">
                <div class="backup-loading">
                    <div class="backup-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Backup List -->
        <div class="backup-list">
            <div class="backup-list-header">
                <h2 class="backup-list-title">üìã Backup History</h2>
                <div class="backup-list-filters">
                    <button class="btn btn-outline btn-sm" onclick="sortBackups('newest')">‚¨á Newest</button>
                    <button class="btn btn-outline btn-sm" onclick="sortBackups('oldest')">‚¨Ü Oldest</button>
                    <button class="btn btn-outline btn-sm" onclick="sortBackups('size')">üì¶ Size</button>
                </div>
            </div>
            <div class="backup-items" id="backupList">
                <div class="backup-loading">
                    <div class="backup-spinner"></div>
                    <p>Loading backups...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Modal -->
    <div id="restoreModal" class="backup-modal" style="display: none;">
        <div class="backup-modal-content">
            <div class="backup-modal-header">
                <h2 class="backup-modal-title">üîÑ Restore Backup</h2>
            </div>
            <div class="backup-modal-body" id="restoreModalBody">
                <!-- Content will be injected here -->
            </div>
            <div class="backup-modal-footer">
                <button class="btn btn-outline" onclick="closeRestoreModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRestore()">Restore</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/layer74-backup-recovery.js"></script>

    <script>
        let selectedBackupId = null;
        let selectedSources = [];

        // Wait for backup engine to initialize
        setTimeout(() => {
            if (window.BackupEngine) {
                initializeDashboard();
            } else {
                console.error('Backup Engine not loaded');
            }
        }, 1000);

        function initializeDashboard() {
            console.log('üíæ Initializing Backup Dashboard');

            // Update stats
            updateStats();

            // Render sources
            renderSources();

            // Render schedules
            renderSchedules();

            // Render backups
            renderBackups();

            // Setup event listeners
            setupEventListeners();

            // Auto-refresh
            setInterval(updateStats, 5000);
            setInterval(renderSchedules, 10000);
        }

        function updateStats() {
            const stats = window.BackupEngine.getStats();
            const state = window.BackupEngine.state();
            const backups = window.BackupEngine.getAllBackups();

            document.getElementById('statTotalBackups').textContent = backups.length;

            const successRate = stats.totalBackups > 0
                ? ((stats.successfulBackups / stats.totalBackups) * 100).toFixed(0)
                : 100;
            document.getElementById('statSuccessRate').textContent = successRate + '%';

            const storageKB = (stats.storageUsed / 1024).toFixed(2);
            document.getElementById('statStorageUsed').textContent = storageKB + ' KB';

            document.getElementById('statActiveSchedules').textContent = state.schedules;
        }

        function renderSources() {
            const sources = window.BackupEngine.getSources({ enabled: true });
            const container = document.getElementById('sourceSelector');

            if (sources.length === 0) {
                container.innerHTML = '<p>No sources configured</p>';
                return;
            }

            // Select all by default
            selectedSources = sources.map(s => s.id);

            container.innerHTML = sources.map(source => `
                <div class="backup-source-item selected" onclick="toggleSource('${source.id}')">
                    <input type="checkbox" class="backup-source-checkbox" checked
                        id="source-${source.id}" onchange="event.stopPropagation()">
                    <label class="backup-source-label" for="source-${source.id}">
                        ${source.name}
                    </label>
                </div>
            `).join('');
        }

        function toggleSource(sourceId) {
            const index = selectedSources.indexOf(sourceId);
            const item = event.currentTarget;
            const checkbox = item.querySelector('input');

            if (index > -1) {
                selectedSources.splice(index, 1);
                item.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedSources.push(sourceId);
                item.classList.add('selected');
                checkbox.checked = true;
            }
        }

        function renderSchedules() {
            const schedules = window.BackupEngine.getSchedules();
            const container = document.getElementById('scheduleList');

            if (schedules.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-gray-500);">No active schedules</p>';
                return;
            }

            container.innerHTML = schedules.map(schedule => {
                const intervalMin = (schedule.interval / 60000).toFixed(0);
                const nextBackup = schedule.nextBackup
                    ? new Date(schedule.nextBackup).toLocaleTimeString()
                    : 'N/A';

                return `
                    <div class="backup-schedule-item">
                        <div class="backup-schedule-info">
                            <div class="backup-schedule-name">${schedule.id}</div>
                            <div class="backup-schedule-interval">
                                Every ${intervalMin} minutes ‚Ä¢ Next: ${nextBackup}
                            </div>
                        </div>
                        <div class="backup-schedule-status ${schedule.enabled ? 'active' : 'inactive'}">
                            <span class="backup-schedule-dot"></span>
                            <span>${schedule.enabled ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderBackups(sort = 'newest') {
            let backups = window.BackupEngine.getAllBackups();
            const container = document.getElementById('backupList');

            if (backups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-gray-500); padding: 2rem;">No backups yet. Create your first backup!</p>';
                return;
            }

            // Sort
            if (sort === 'oldest') {
                backups = backups.reverse();
            } else if (sort === 'size') {
                backups.sort((a, b) => b.size - a.size);
            }

            container.innerHTML = backups.map(backup => {
                const date = new Date(backup.timestamp).toLocaleString();
                const size = formatSize(backup.size);
                const isScheduled = backup.metadata?.scheduled || false;

                return `
                    <div class="backup-item backup-fade-in">
                        <div class="backup-item-header">
                            <div class="backup-item-info">
                                <h3 class="backup-item-name">${backup.name}</h3>
                                <div class="backup-item-meta">
                                    <div class="backup-item-meta-item">
                                        üìÖ ${date}
                                    </div>
                                    <div class="backup-item-meta-item">
                                        üì¶ ${size}
                                    </div>
                                    <div class="backup-item-meta-item">
                                        ${backup.compressed ? 'üóúÔ∏è Compressed' : 'üìÑ Uncompressed'}
                                    </div>
                                    ${isScheduled ? '<span class="backup-badge info">Scheduled</span>' : '<span class="backup-badge success">Manual</span>'}
                                </div>
                            </div>
                            <div class="backup-item-actions">
                                <button class="btn btn-primary btn-sm" onclick="openRestoreModal('${backup.id}')">
                                    üîÑ Restore
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.id}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        <div class="backup-item-sources">
                            ${backup.sources.map(s => `<span class="backup-source-badge">${s}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setupEventListeners() {
            document.addEventListener('backup:created', (e) => {
                showAlert('Backup created successfully!', 'success');
                updateStats();
                renderBackups();
            });

            document.addEventListener('backup:restored', (e) => {
                showAlert('Backup restored successfully!', 'success');
                closeRestoreModal();
            });

            document.addEventListener('backup:deleted', (e) => {
                showAlert('Backup deleted', 'info');
                updateStats();
                renderBackups();
            });

            document.addEventListener('backup:failed', (e) => {
                showAlert('Backup failed: ' + e.detail.error, 'error');
            });
        }

        async function createBackup() {
            if (selectedSources.length === 0) {
                showAlert('Please select at least one source', 'warning');
                return;
            }

            showAlert('Creating backup...', 'info');

            const result = await window.BackupEngine.createBackup({
                name: `manual-${Date.now()}`,
                sources: selectedSources,
                metadata: { manual: true }
            });

            if (!result.success) {
                showAlert('Backup failed: ' + result.error, 'error');
            }
        }

        function openRestoreModal(backupId) {
            selectedBackupId = backupId;
            const backup = window.BackupEngine.getAllBackups().find(b => b.id === backupId);

            if (!backup) return;

            const modal = document.getElementById('restoreModal');
            const body = document.getElementById('restoreModalBody');

            body.innerHTML = `
                <div class="backup-alert warning">
                    <div class="backup-alert-icon">‚ö†Ô∏è</div>
                    <div>
                        <strong>Warning:</strong> This will overwrite current data with the backup.
                        Make sure you want to proceed.
                    </div>
                </div>
                <h3>Backup Details:</h3>
                <p><strong>Name:</strong> ${backup.name}</p>
                <p><strong>Date:</strong> ${new Date(backup.timestamp).toLocaleString()}</p>
                <p><strong>Size:</strong> ${formatSize(backup.size)}</p>
                <p><strong>Sources:</strong> ${backup.sources.join(', ')}</p>
                <div class="backup-progress" style="display: none;">
                    <div class="backup-progress-bar" style="width: 0%"></div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function closeRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
            selectedBackupId = null;
        }

        async function confirmRestore() {
            if (!selectedBackupId) return;

            showAlert('Restoring backup...', 'info');

            const result = await window.BackupEngine.restoreBackup(selectedBackupId);

            if (!result.success) {
                showAlert('Restore failed: ' + result.error, 'error');
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm('Are you sure you want to delete this backup?')) return;

            window.BackupEngine.deleteBackup(backupId);
        }

        function sortBackups(sort) {
            renderBackups(sort);
        }

        function refreshDashboard() {
            updateStats();
            renderBackups();
            renderSchedules();
            showAlert('Dashboard refreshed', 'info');
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };

            const alert = document.createElement('div');
            alert.className = `backup-alert ${type}`;
            alert.innerHTML = `
                <div class="backup-alert-icon">${icons[type]}</div>
                <div>${message}</div>
            `;

            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => alert.remove(), 5000);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('restoreModal');
            if (e.target === modal) {
                closeRestoreModal();
            }
        });
    </script>
</body>

</html>